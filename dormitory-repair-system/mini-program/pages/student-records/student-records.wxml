<view class="container">
  <view class="header">
    <view class="header-title">æˆ‘çš„æŠ¥ä¿®è®°å½•</view>
  </view>

  <view class="tab-bar">
    <view
      class="tab-item {{currentTab === item.key ? 'active' : ''}}"
      wx:for="{{tabs}}"
      wx:key="key"
      data-tab="{{item.key}}"
      bindtap="onTabChange"
    >
      <text class="tab-text">{{item.label}}</text>
      <view class="tab-indicator" wx:if="{{currentTab === item.key}}"></view>
    </view>
  </view>

  <scroll-view
    class="order-list"
    scroll-y="true"
    refresher-enabled="true"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscrolltolower="onLoadMore"
  >
    <view class="order-card" wx:for="{{orders}}" wx:key="orderId" data-id="{{item.orderId}}" bindtap="onOrderClick">
      <view class="order-header">
        <view class="order-type">{{item.repairType}}</view>
        <view class="status-badge" style="background-color: {{item.statusInfo.bgColor}}; color: {{item.statusInfo.color}};">
          {{item.statusInfo.text}}
        </view>
      </view>

      <view class="order-body">
        <view class="location-info">
          <view class="info-row">
            <text class="info-icon">ğŸ“</text>
            <text class="info-text">{{item.building}} {{item.roomNumber}}</text>
          </view>
          <view class="info-row">
            <text class="info-icon">ğŸ“</text>
            <text class="info-text">{{item.contactPhone}}</text>
          </view>
        </view>

        <view class="description" wx:if="{{item.description}}">
          <text class="desc-text">{{item.description}}</text>
        </view>

        <view class="image-preview" wx:if="{{item.images && item.images.length > 0}}">
          <image
            class="preview-img"
            wx:for="{{item.images.slice(0, 3)}}"
            wx:for-item="img"
            wx:key="imageId"
            src="{{img.imageUrl}}"
            mode="aspectFill"
            data-url="{{img.imageUrl}}"
            data-urls="{{item.images.map(i => i.imageUrl)}}"
            catchtap="onPreviewImage"
          />
          <view class="more-images" wx:if="{{item.images.length > 3}}">
            <text class="more-text">+{{item.images.length - 3}}</text>
          </view>
        </view>
      </view>

      <view class="order-footer">
        <text class="order-id">å•å·: {{item.orderId}}</text>
        <text class="order-time">{{item.createdAtFormatted}}</text>
      </view>
    </view>

    <view class="empty-state" wx:if="{{orders.length === 0 && !loading}}">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— {{currentTab ? tabs.find(t => t.key === currentTab).label : ''}}è®°å½•</text>
      <text class="empty-subtext">ç‚¹å‡»å³ä¸‹è§’"æˆ‘è¦æŠ¥ä¿®"æŒ‰é’®æäº¤æ–°è®¢å•</text>
    </view>

    <view class="loading-more" wx:if="{{loading && orders.length > 0}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <view class="no-more" wx:if="{{!hasMore && orders.length > 0}}">
      <text>æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
    </view>
  </scroll-view>
</view>

<view class="modal-overlay" wx:if="{{showDetailModal}}" bindtap="onCloseDetail">
  <view class="detail-modal" catchtap="preventClose">
    <view class="modal-header">
      <text class="modal-title">è®¢å•è¯¦æƒ…</text>
      <view class="close-btn" bindtap="onCloseDetail">âœ•</view>
    </view>

    <scroll-view class="modal-body" scroll-y="true">
      <view class="detail-section" wx:if="{{currentOrder}}">
        <view class="detail-row">
          <text class="detail-label">æŠ¥ä¿®ç±»å‹</text>
          <text class="detail-value">{{currentOrder.repairType}}</text>
        </view>

        <view class="detail-row">
          <text class="detail-label">è®¢å•çŠ¶æ€</text>
          <view class="detail-badge" style="background-color: {{currentOrder.statusInfo.bgColor}}; color: {{currentOrder.statusInfo.color}};">
            {{currentOrder.statusInfo.text}}
          </view>
        </view>

        <view class="detail-row">
          <text class="detail-label">ä½ç½®</text>
          <text class="detail-value">{{currentOrder.building}} {{currentOrder.roomNumber}}</text>
        </view>

        <view class="detail-row">
          <text class="detail-label">è”ç³»ç”µè¯</text>
          <text class="detail-value">{{currentOrder.contactPhone}}</text>
        </view>

        <view class="detail-row">
          <text class="detail-label">æŠ¥ä¿®æ—¶é—´</text>
          <text class="detail-value">{{currentOrder.createdAtFormatted}}</text>
        </view>

        <view class="detail-block" wx:if="{{currentOrder.description}}">
          <text class="detail-label">é—®é¢˜æè¿°</text>
          <text class="detail-desc">{{currentOrder.description}}</text>
        </view>

        <view class="detail-block" wx:if="{{currentOrder.images && currentOrder.images.length > 0}}">
          <text class="detail-label">æŠ¥ä¿®å›¾ç‰‡</text>
          <view class="detail-images">
            <image
              class="detail-img"
              wx:for="{{currentOrder.images}}"
              wx:for-item="img"
              wx:key="imageId"
              src="{{img.imageUrl}}"
              mode="aspectFill"
              data-url="{{img.imageUrl}}"
              data-urls="{{currentOrder.images.map(i => i.imageUrl)}}"
              bindtap="onPreviewImage"
            />
          </view>
        </view>

        <view class="detail-block" wx:if="{{currentOrder.completionImages && currentOrder.completionImages.length > 0}}">
          <text class="detail-label">å®Œæˆå›¾ç‰‡</text>
          <view class="detail-images">
            <image
              class="detail-img"
              wx:for="{{currentOrder.completionImages}}"
              wx:for-item="img"
              wx:key="imageId"
              src="{{img.imageUrl}}"
              mode="aspectFill"
              data-url="{{img.imageUrl}}"
              data-urls="{{currentOrder.completionImages.map(i => i.imageUrl)}}"
              bindtap="onPreviewImage"
            />
          </view>
        </view>

        <view class="detail-block evaluation-block" wx:if="{{currentOrder.evaluation}}">
          <text class="detail-label">æˆ‘çš„è¯„ä»·</text>
          <view class="evaluation-display">
            <view class="star-display">
              <text class="star filled" wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:if="{{item <= currentOrder.evaluation.rating}}">â˜…</text>
              <text class="star" wx:for="{{[1,2,3,4,5]}}" wx:key="*this" wx:if="{{item > currentOrder.evaluation.rating}}">â˜…</text>
            </view>
            <text class="evaluation-content">{{currentOrder.evaluation.comment || currentOrder.evaluation.content}}</text>
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="modal-footer" wx:if="{{currentOrder && currentOrder.status === 'completed' && !currentOrder.evaluation}}">
      <button class="eval-btn" bindtap="onGoToEvaluation">å»è¯„ä»·</button>
    </view>
    <view class="modal-footer evaluated" wx:if="{{currentOrder && currentOrder.status === 'completed' && currentOrder.evaluation}}">
      <text class="evaluated-text">å·²å®Œæˆè¯„ä»·</text>
    </view>
  </view>
</view>
