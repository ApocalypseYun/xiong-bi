<view class="container">
  <view class="header">
    <view class="header-title">ç»´ä¿®è¯„ä»·</view>
    <view class="header-subtitle" wx:if="{{!order}}">è¯·é€‰æ‹©è¦è¯„ä»·çš„è®¢å•</view>
  </view>

  <view class="content" wx:if="{{order}}">
    <view class="order-card">
      <view class="card-header">
        <text class="card-title">è®¢å•ä¿¡æ¯</text>
        <view class="switch-btn" bindtap="onSwitchOrder" wx:if="{{!existingEvaluation}}">
          <text>åˆ‡æ¢è®¢å•</text>
        </view>
      </view>

      <view class="order-info">
        <view class="info-item">
          <text class="info-label">æŠ¥ä¿®ç±»å‹</text>
          <text class="info-value">{{order.repairType}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">ä½ç½®</text>
          <text class="info-value">{{order.building}} {{order.roomNumber}}</text>
        </view>
        <view class="info-item">
          <text class="info-label">å®Œæˆæ—¶é—´</text>
          <text class="info-value">{{order.completedAt}}</text>
        </view>
      </view>

      <view class="completion-images" wx:if="{{order.completionImages && order.completionImages.length > 0}}">
        <text class="section-label">ç»´ä¿®å®Œæˆå›¾ç‰‡</text>
        <view class="images-row">
          <image
            class="completion-img"
            wx:for="{{order.completionImages}}"
            wx:for-item="img"
            wx:key="imageId"
            src="{{img.imageUrl}}"
            mode="aspectFill"
            data-url="{{img.imageUrl}}"
            bindtap="onPreviewImage"
          />
        </view>
      </view>
    </view>

    <view class="evaluation-card">
      <view class="card-header">
        <text class="card-title">{{existingEvaluation ? 'æˆ‘çš„è¯„ä»·' : 'å¡«å†™è¯„ä»·'}}</text>
      </view>

      <view class="rating-section">
        <text class="section-label">æœåŠ¡è¯„åˆ†</text>
        <view class="star-rating">
          <view
            class="star-item {{rating >= item ? 'active' : ''}} {{existingEvaluation ? 'disabled' : ''}}"
            wx:for="{{[1, 2, 3, 4, 5]}}"
            wx:key="*this"
            data-rating="{{item}}"
            bindtap="onRatingChange"
          >
            <text class="star-icon">â˜…</text>
          </view>
        </view>
        <text class="rating-text" wx:if="{{rating > 0}}">
          {{rating === 1 ? 'éå¸¸ä¸æ»¡æ„' : rating === 2 ? 'ä¸æ»¡æ„' : rating === 3 ? 'ä¸€èˆ¬' : rating === 4 ? 'æ»¡æ„' : 'éå¸¸æ»¡æ„'}}
        </text>
      </view>

      <view class="content-section" wx:if="{{!existingEvaluation}}">
        <text class="section-label">è¯„ä»·å†…å®¹</text>
        <textarea
          class="content-input"
          placeholder="è¯·åˆ†äº«æ‚¨çš„ç»´ä¿®ä½“éªŒ..."
          value="{{content}}"
          maxlength="500"
          bindinput="onContentInput"
          disabled="{{existingEvaluation}}"
        />
        <view class="char-count">
          <text>{{content.length}}/500</text>
        </view>
      </view>

      <view class="content-display" wx:if="{{existingEvaluation}}">
        <text class="content-text">{{content || 'æš‚æ— è¯„ä»·å†…å®¹'}}</text>
        <view class="eval-time" wx:if="{{existingEvaluation.createdAt}}">
          <text>è¯„ä»·æ—¶é—´: {{existingEvaluation.createdAt}}</text>
        </view>
      </view>
    </view>

    <view class="action-area" wx:if="{{!existingEvaluation}}">
      <button
        class="submit-btn {{rating === 0 ? 'disabled' : ''}}"
        bindtap="onSubmit"
        disabled="{{submitting || rating === 0}}"
      >
        {{submitting ? 'æäº¤ä¸­...' : 'æäº¤è¯„ä»·'}}
      </button>
    </view>
  </view>

  <view class="empty-order" wx:if="{{!order && !loading}}">
    <view class="empty-icon">ğŸ“</view>
    <text class="empty-text">è¯·å…ˆé€‰æ‹©è¦è¯„ä»·çš„è®¢å•</text>
    <button class="select-btn" bindtap="onSwitchOrder">é€‰æ‹©è®¢å•</button>
  </view>
</view>

<view class="modal-overlay" wx:if="{{showOrderSelector}}">
  <view class="selector-modal">
    <view class="selector-header">
      <text class="selector-title">é€‰æ‹©è¦è¯„ä»·çš„è®¢å•</text>
      <view class="close-btn" bindtap="onCloseSelector">âœ•</view>
    </view>

    <scroll-view class="order-list" scroll-y="true">
      <view
        class="selector-order-item"
        wx:for="{{completedOrders}}"
        wx:key="orderId"
        data-id="{{item.orderId}}"
        bindtap="onSelectOrder"
      >
        <view class="selector-order-header">
          <text class="selector-order-type">{{item.repairType}}</text>
          <view class="completed-badge">å·²å®Œæˆ</view>
        </view>
        <view class="selector-order-info">
          <text class="selector-order-location">ğŸ“ {{item.building}} {{item.roomNumber}}</text>
          <text class="selector-order-time">{{item.createdAt}}</text>
        </view>
      </view>

      <view class="empty-orders" wx:if="{{completedOrders.length === 0}}">
        <text>æš‚æ— å¯è¯„ä»·çš„è®¢å•</text>
      </view>
    </scroll-view>
  </view>
</view>

<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>
</view>
